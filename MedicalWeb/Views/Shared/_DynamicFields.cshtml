@using MedicalBot.Entities.Platform
@using System.Text.Json
@model MedicalBot.Entities.IHasDynamicProperties
@using Microsoft.AspNetCore.Html

@{
    var fields = ViewBag.DynamicFields as List<AppFieldDefinition>;
    var values = new Dictionary<string, object>();
    
    if (!string.IsNullOrEmpty(Model?.Properties))
    {
        try { 
            values = JsonSerializer.Deserialize<Dictionary<string, object>>(Model.Properties) ?? new Dictionary<string, object>(); 
        }
        catch { }
    }
}

@if (fields != null && fields.Any())
{
    <div class="mt-4 mb-3 pt-3 border-top">
        <h5 class="text-secondary mb-3">Дополнительные параметры</h5>
    </div>

    <div class="container-fluid px-0">
        @foreach (var field in fields.OrderBy(f => f.SortOrder))
        {
            var formKey = $"DynamicProps[{field.SystemName}]";
            var hasError = ViewData.ModelState.ContainsKey(formKey) && ViewData.ModelState[formKey].Errors.Any();
            
            values.TryGetValue(field.SystemName, out var rawValue);
            
            var currentValues = new List<string>();
            if (rawValue is JsonElement element)
            {
                if (element.ValueKind == JsonValueKind.Array)
                    currentValues = element.EnumerateArray().Select(x => x.ToString()).ToList();
                else
                    currentValues.Add(element.ToString());
            }
            else if (rawValue != null)
            {
                currentValues.Add(rawValue.ToString());
            }

            if (!currentValues.Any()) currentValues.Add("");

            <div class="row mb-3 align-items-start">
                <label class="col-sm-2 col-form-label text-muted text-sm-end fw-bold">
                    @field.Label
                    @if (field.IsRequired) { <span class="text-danger">*</span> }
                </label>

                <div class="col-sm-10">
                    <div id="container_@field.SystemName" class="dynamic-field-container">
                        @foreach (var val in currentValues)
                        {
                            <div class="input-group mb-2 dynamic-field-item">
                                @renderField(field, val, hasError)
                                
                                @if (field.IsArray)
                                {
                                    <button type="button" class="btn btn-outline-danger" onclick="this.closest('.dynamic-field-item').remove()">
                                        <i class="bi bi-x"></i>
                                    </button>
                                }
                            </div>
                        }
                    </div>

                    @if (hasError)
                    {
                        <div class="text-danger small mt-1">
                            @foreach (var error in ViewData.ModelState[formKey].Errors)
                            {
                                <div><i class="bi bi-exclamation-circle"></i> @error.ErrorMessage</div>
                            }
                        </div>
                    }

                    @if (field.IsArray)
                    {
                        <button type="button" class="btn btn-sm btn-outline-secondary mt-1" 
                                onclick="addDynamicField('@field.SystemName', '@field.DataType')">
                            <i class="bi bi-plus-lg"></i> Добавить еще
                        </button>
                    }
                </div>
            </div>
        }
    </div>

    <div id="field_templates" style="display:none;">
        <div data-type="String"><input type="text" class="form-control" /></div>
        <div data-type="Number"><input type="number" step="any" class="form-control" /></div>
        <div data-type="Money"><input type="number" step="0.01" class="form-control" placeholder="0.00" /></div>
        <div data-type="Date"><input type="date" class="form-control" /></div>
        <div data-type="DateTime"><input type="datetime-local" class="form-control" /></div>
        <div data-type="File"><input type="file" class="form-control" /></div>
        <div data-type="Boolean">
            <div class="form-check form-switch mt-2">
                <input class="form-check-input" type="checkbox" value="true">
            </div>
        </div>
    </div>

    <script>
        function addDynamicField(systemName, dataType) {
            const container = document.getElementById('container_' + systemName);
            const template = document.querySelector(`#field_templates [data-type="${dataType}"]`) 
                          || document.querySelector(`#field_templates [data-type="String"]`);
            
            const wrapper = document.createElement('div');
            wrapper.className = 'input-group mb-2 dynamic-field-item';
            
            const content = template.cloneNode(true);
            const input = content.querySelector('input') || content.querySelector('textarea');
            input.name = `DynamicProps[${systemName}]`;
            
            const btn = document.createElement('button');
            btn.type = 'button';
            btn.className = 'btn btn-outline-danger';
            btn.innerHTML = '<i class="bi bi-x"></i>';
            btn.onclick = function() { this.closest('.dynamic-field-item').remove(); };
            
            wrapper.appendChild(content.classList.contains('form-check') ? content : content.firstElementChild || content);
            wrapper.appendChild(btn);
            container.appendChild(wrapper);
        }
    </script>
}

@functions {
    IHtmlContent renderField(AppFieldDefinition field, string value, bool hasError)
    {
        var fieldName = $"DynamicProps[{field.SystemName}]";
        var required = field.IsRequired ? "required" : "";
        var errorClass = hasError ? "is-invalid" : "";
        
        switch (field.DataType)
        {
            case FieldDataType.Number:
                return new HtmlString($"<input type=\"number\" step=\"any\" name=\"{fieldName}\" value=\"{valForInput(value)}\" class=\"form-control {errorClass}\" {required} />");
            
            case FieldDataType.Money:
                return new HtmlString($"<input type=\"number\" step=\"0.01\" name=\"{fieldName}\" value=\"{valForInput(value)}\" class=\"form-control {errorClass}\" placeholder=\"0.00\" {required} />");
            
            case FieldDataType.Date:
                return new HtmlString($"<input type=\"date\" name=\"{fieldName}\" value=\"{valForDate(value)}\" class=\"form-control {errorClass}\" {required} />");

            case FieldDataType.DateTime:
                return new HtmlString($"<input type=\"datetime-local\" name=\"{fieldName}\" value=\"{valForDate(value, true)}\" class=\"form-control {errorClass}\" {required} />");

            case FieldDataType.File:
                // Для файлов выводим input type="file"
                return new HtmlString($"<input type=\"file\" name=\"{fieldName}\" class=\"form-control {errorClass}\" {required} />");

            case FieldDataType.Boolean:
                var checkedAttr = value.ToLower() == "true" ? "checked" : "";
                return new HtmlString($@"
                    <div class=""form-check form-switch mt-2"">
                        <input type=""hidden"" name=""{fieldName}"" value=""false"" />
                        <input class=""form-check-input"" type=""checkbox"" name=""{fieldName}"" value=""true"" {checkedAttr} />
                    </div>");

            case FieldDataType.Text:
                return new HtmlString($"<textarea name=\"{fieldName}\" class=\"form-control {errorClass}\" rows=\"3\" {required}>{value}</textarea>");

            default:
                return new HtmlString($"<input type=\"text\" name=\"{fieldName}\" value=\"{value}\" class=\"form-control {errorClass}\" {required} />");
        }
    }

    string valForInput(string val) => val?.Replace(",", ".");
    
    string valForDate(string val, bool isDateTime = false) {
        if (DateTime.TryParse(val, out DateTime dt))
            return dt.ToString(isDateTime ? "yyyy-MM-ddTHH:mm" : "yyyy-MM-dd");
        return "";
    }
}