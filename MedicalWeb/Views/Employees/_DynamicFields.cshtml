@using MedicalBot.Entities.Platform
@using System.Text.Json
@model MedicalBot.Entities.Company.Employee

@{
    var fields = ViewBag.DynamicFields as List<AppFieldDefinition>;
    var values = new Dictionary<string, string>();
    
    if (!string.IsNullOrEmpty(Model?.Properties))
    {
        try 
        { 
            values = JsonSerializer.Deserialize<Dictionary<string, string>>(Model.Properties) ?? new Dictionary<string, string>(); 
        }
        catch { /* Ошибка парсинга JSON */ }
    }
}

@if (fields != null && fields.Any())
{
    <div class="card mb-4 border-info shadow-sm">
        <div class="card-header bg-info text-white d-flex align-items-center">
            <i class="bi bi-cpu-fill me-2"></i>
            <h5 class="mb-0">Дополнительные параметры</h5>
        </div>
        <div class="card-body">
            <div class="row">
                @foreach (var field in fields)
                {
                    values.TryGetValue(field.SystemName, out var currentValue);
                    currentValue ??= "";
                    
                    <div class="col-md-4 mb-3">
                        <label class="form-label fw-bold text-secondary">@field.Label</label>
                        
                        @switch (field.DataType)
                        {
                            @* Обычная строка *@
                            case FieldDataType.String:
                                <input type="text" name="DynamicProps[@field.SystemName]" value="@currentValue" 
                                       class="form-control" @(field.IsRequired ? "required" : "") />
                                break;

                            @* Многострочный текст *@
                            case FieldDataType.Text:
                                <textarea name="DynamicProps[@field.SystemName]" class="form-control" 
                                          rows="3" @(field.IsRequired ? "required" : "")>@currentValue</textarea>
                                break;

                            @* Число *@
                            case FieldDataType.Number:
                                <input type="number" name="DynamicProps[@field.SystemName]" value="@currentValue" 
                                       class="form-control" step="any" @(field.IsRequired ? "required" : "") />
                                break;

                            @* Деньги *@
                            case FieldDataType.Money:
                                <div class="input-group">
                                    <span class="input-group-text">₽</span>
                                    <input type="number" name="DynamicProps[@field.SystemName]" value="@currentValue" 
                                           class="form-control" step="0.01" @(field.IsRequired ? "required" : "") />
                                </div>
                                break;

                            @* Дата *@
                            case FieldDataType.DateTime:
                                <input type="date" name="DynamicProps[@field.SystemName]" value="@currentValue" 
                                       class="form-control" @(field.IsRequired ? "required" : "") />
                                break;

                            @* Да/Нет *@
                            case FieldDataType.Boolean:
                                <div class="form-check form-switch mt-2">
                                    <input type="hidden" name="DynamicProps[@field.SystemName]" value="false" id="hidden_@field.SystemName" />
                                    <input type="checkbox" name="DynamicProps[@field.SystemName]" value="true" 
                                           class="form-check-input" id="check_@field.SystemName"
                                           @(currentValue.ToLower() == "true" ? "checked" : "") 
                                           onclick="document.getElementById('hidden_@field.SystemName').disabled = this.checked;" />
                                    <label class="form-check-label" for="check_@field.SystemName"></label>
                                </div>
                                break;

                            @* Ссылки и Таблицы (на будущее) *@
                            case FieldDataType.EntityLink:
                            case FieldDataType.Table:
                            case FieldDataType.File:
                                <div class="alert alert-light border py-1 mb-0 small">
                                    <i class="bi bi-info-circle"></i> Тип @field.DataType в разработке
                                    <input type="hidden" name="DynamicProps[@field.SystemName]" value="@currentValue" />
                                </div>
                                break;

                            default:
                                <input type="text" name="DynamicProps[@field.SystemName]" value="@currentValue" class="form-control" />
                                break;
                        }
                    </div>
                }
            </div>
        </div>
    </div>
}